{% extends 'monitoring/base.html' %}
{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>{{ page_title }}</h1>
</div>
<hr>

{% if not latest_test or latest_test.status == 'COMPLETED' or latest_test.status == 'ABORTED' %}
<div class="card text-center shadow-sm">
    <div class="card-body p-5">
        <h3 class="card-title">Aktif Test Seansı Bulunmuyor</h3>
        <p class="card-text text-muted">Yeni bir test döngüsü başlatmak için butona tıklayın.</p>
        <a href="{% url 'monitoring:new_test' %}" class="btn btn-primary btn-lg mt-3"><i
                class="bi bi-plus-circle-fill me-2"></i>Yeni Test Başlat</a>
    </div>
</div>

{% elif latest_test.status == 'NOT_STARTED' %}
<div class="card text-center shadow-sm border-warning">
    <div class="card-body p-5">
        <h3 class="card-title">"{{ latest_test.test_name }}" Testi Başlatılmayı Bekliyor</h3>
        <p class="card-text text-muted">Teste başlamadan önce tüm cihazların bağlı ve çalışır durumda olduğundan emin
            olun.</p>
        <form method="post" action="{% url 'monitoring:start_test' pk=latest_test.pk %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-success btn-lg mt-3"><i class="bi bi-play-circle-fill me-2"></i>TESTİ
                BAŞLAT</button>
        </form>
    </div>
</div>

{% else %}
<div class="card shadow-sm">
    <div class="card-header fs-5 d-flex justify-content-between align-items-center">
        <span>Aktif Test Seansı: <strong>{{ latest_test.test_name }}</strong></span>

        {% if latest_test.status == 'RUNNING' %}
        <span class="badge bg-success">Çalışıyor</span>
        {% elif latest_test.status == 'PAUSED' %}
        <span class="badge bg-warning text-dark">Duraklatıldı</span>
        {% endif %}
    </div>
    <div class="card-body p-4">
        <div id="test-progress-panel" data-status="{{ latest_test.status }}"
            data-elapsed-seconds="{{ latest_test.elapsed_seconds }}"
            data-target-seconds="{{ latest_test.target_duration_seconds }}"
            data-resume-time="{% if latest_test.last_resumed_time %}{{ latest_test.last_resumed_time.isoformat }}{% endif %}">

            <div class="row align-items-center">
                <div class="col-md-6 text-center mb-4 mb-md-0">
                    <h4>Kalan Süre</h4>
                    <h1 class="display-4 fw-bold" id="countdown-timer">--:--:--</h1>
                    <div class="progress" role="progressbar" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                            id="progress-bar" style="width: 0%;">
                            <span id="progress-bar-text" class="fw-bold">0%</span>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <h4 class="text-center text-md-start">Testi Yönet</h4>
                    <p class="text-muted text-center text-md-start">Mevcut test seansını yönetin.</p>
                    <div class="d-grid gap-2">

                        {% if latest_test.status == 'RUNNING' %}
                        <form method="post" action="{% url 'monitoring:pause_test' pk=latest_test.pk %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-warning w-100"><i
                                    class="bi bi-pause-circle me-2"></i>Testi Duraklat</button>
                        </form>
                        {% elif latest_test.status == 'PAUSED' %}
                        <form method="post" action="{% url 'monitoring:resume_test' pk=latest_test.pk %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-info w-100"><i class="bi bi-play-circle me-2"></i>Testi
                                Devam Ettir</button>
                        </form>
                        {% endif %}

                        <form method="post" action="{% url 'monitoring:abort_test' pk=latest_test.pk %}"
                            onsubmit="return confirm('Bu testi erken sonlandırmak istediğinizden emin misiniz? Bu işlem geri alınamaz.');">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger w-100"><i
                                    class="bi bi-stop-circle me-2"></i>Testi Sonlandır</button>
                        </form>

                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="card-footer text-muted">
        Başlangıç: {{ latest_test.start_time|date:"d M Y, H:i" }} | Müşteri: {{ latest_test.customer_name|default:"Belirtilmemiş" }}
    </div>
</div>
{% endif %}
{% if past_tests %}
<hr class="my-4">
<h2>Tüm Test Seansları</h2>
<p class="text-muted">Bir testin raporunu görüntülemek için üzerine tıklayın.</p>
<div class="list-group">
    {% for test in past_tests %}
    <a href="{% url 'monitoring:historical_data' %}?test_run_id={{ test.pk }}"
        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
        <div>
            <h5 class="mb-1">#{{ test.pk }} - {{ test.test_name }}</h5>
            <small>Bitiş Zamanı: {{ test.end_time|date:"d M Y, H:i" }}</small>
        </div>
        {% if test.status == 'COMPLETED' %}
        <span class="badge bg-success rounded-pill">{{ test.get_status_display }}</span>
        {% else %}
        <span class="badge bg-danger rounded-pill">{{ test.get_status_display }}</span>
        {% endif %}
    </a>
    {% endfor %}
</div>
{% endif %}
{% endblock %}
{% block scripts %}
{{ block.super }}
<script>
    // Sizin paylaştığınız geri sayım script'i buradaydı, o doğruydu.
    // Onu tekrar buraya ekliyoruz.
    document.addEventListener('DOMContentLoaded', function () {
        const progressPanel = document.getElementById('test-progress-panel');
        if (!progressPanel) return;

        const status = progressPanel.dataset.status;
        const elapsedSeconds = parseFloat(progressPanel.dataset.elapsedSeconds);
        const targetSeconds = parseInt(progressPanel.dataset.targetSeconds);
        const resumeTime = progressPanel.dataset.resumeTime ? new Date(progressPanel.dataset.resumeTime) : null;

        const timerDisplay = document.getElementById('countdown-timer');
        const progressBar = document.getElementById('progress-bar');
        const progressBarText = document.getElementById('progress-bar-text');

        let intervalId = null;

        function formatTime(totalSeconds) {
            totalSeconds = Math.floor(totalSeconds);
            if (totalSeconds < 0) totalSeconds = 0;
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return String(hours).padStart(4, '0') + ':' +
                String(minutes).padStart(2, '0') + ':' +
                String(seconds).padStart(2, '0');
        }

        function updateTimer() {
            let currentTotalElapsed = elapsedSeconds;
            if (status === 'RUNNING' && resumeTime) {
                const now = new Date();
                const secondsSinceResume = (now - resumeTime) / 1000;
                currentTotalElapsed += secondsSinceResume;
            }
            const remainingSeconds = targetSeconds - currentTotalElapsed;
            if (remainingSeconds <= 0) {
                timerDisplay.textContent = "TAMAMLANDI";
                progressBar.style.width = '100%';
                progressBarText.textContent = '100%';
                progressBar.classList.remove('progress-bar-animated');
                clearInterval(intervalId);
            } else {
                const percentage = (currentTotalElapsed / targetSeconds) * 100;
                const finalPercentage = Math.min(100, Math.max(0, percentage));
                timerDisplay.textContent = formatTime(remainingSeconds);
                progressBar.style.width = finalPercentage.toFixed(2) + '%';
                progressBarText.textContent = finalPercentage.toFixed(1) + '%';
            }
        }

        if (status === 'RUNNING') {
            intervalId = setInterval(updateTimer, 1000);
        } else {
            updateTimer();
        }
    });
</script>
{% endblock %}
